import pandas as pd
import numpy as np
import joblib
import argparse
import time
import os
from tqdm import tqdm

message = """
 ███▄ ▄███▓ ▄▄▄       ██▓     █     █░ ▄▄▄       ██▀███  ▓█████  █    ██  ██▀███   ██▓     ▄▄▄       ███▄    █  ▄▄▄       ██▓    ▓██   ██▓▒███████▒▓█████ 
▓██▒▀█▀ ██▒▒████▄    ▓██▒    ▓█░ █ ░█░▒████▄    ▓██ ▒ ██▒▓█   ▀  ██  ▓██▒▓██ ▒ ██▒▓██▒    ▒████▄     ██ ▀█   █ ▒████▄    ▓██▒     ▒██  ██▒▒ ▒ ▒ ▄▀░▓█   ▀ 
▓██    ▓██░▒██  ▀█▄  ▒██░    ▒█░ █ ░█ ▒██  ▀█▄  ▓██ ░▄█ ▒▒███   ▓██  ▒██░▓██ ░▄█ ▒▒██░    ▒██  ▀█▄  ▓██  ▀█ ██▒▒██  ▀█▄  ▒██░      ▒██ ██░░ ▒ ▄▀▒░ ▒███   
▒██    ▒██ ░██▄▄▄▄██ ▒██░    ░█░ █ ░█ ░██▄▄▄▄██ ▒██▀▀█▄  ▒▓█  ▄ ▓▓█  ░██░▒██▀▀█▄  ▒██░    ░██▄▄▄▄██ ▓██▒  ▐▌██▒░██▄▄▄▄██ ▒██░      ░ ▐██▓░  ▄▀▒   ░▒▓█  ▄ 
▒██▒   ░██▒ ▓█   ▓██▒░██████▒░░██▒██▓  ▓█   ▓██▒░██▓ ▒██▒░▒████▒▒▒█████▓ ░██▓ ▒██▒░██████▒ ▓█   ▓██▒▒██░   ▓██░ ▓█   ▓██▒░██████▒  ░ ██▒▓░▒███████▒░▒████▒
░ ▒░   ░  ░ ▒▒   ▓▒█░░ ▒░▓  ░░ ▓░▒ ▒   ▒▒   ▓▒█░░ ▒▓ ░▒▓░░░ ▒░ ░░▒▓▒ ▒ ▒ ░ ▒▓ ░▒▓░░ ▒░▓  ░ ▒▒   ▓▒█░░ ▒░   ▒ ▒  ▒▒   ▓▒█░░ ▒░▓  ░   ██▒▒▒ ░▒▒ ▓░▒░▒░░ ▒░ ░
░  ░      ░  ▒   ▒▒ ░░ ░ ▒  ░  ▒ ░ ░    ▒   ▒▒ ░  ░▒ ░ ▒░ ░ ░  ░░░▒░ ░ ░   ░▒ ░ ▒░░ ░ ▒  ░  ▒   ▒▒ ░░ ░░   ░ ▒░  ▒   ▒▒ ░░ ░ ▒  ░ ▓██/@Xophidia_2021  ░  ░
░      ░     ░   ▒     ░ ░     ░   ░    ░   ▒     ░░   ░    ░    ░░░ ░ ░   ░░   ░   ░ ░     ░   ▒      ░   ░ ░   ░   ▒     ░ ░    ▒ ▒ ░░  ░ ░ ░ ░ ░   ░   
       ░         ░  ░    ░  ░    ░          ░  ░   ░        ░  ░   ░        ░         ░  ░      ░  ░         ░       ░  ░    ░  ░ ░ ░       ░ ░       ░  ░
                                                                                 
Based on :
    - https://acris.aalto.fi/ws/portalfiles/portal/16859732/urlset.csv.zip
    - https://www.unb.ca/cic/datasets/url-2016.html
    - extract URL from OTX Alienvault
    - http://205.174.165.80/CICDataset/ISCX-URL-2016/
    
     In the order : ("Naive Bayes | LogisticRegression | RandomForest")
     pynb file : 
"""

def verif_dir(_dir):
  if not os.path.isdir(dir_c):
    raise Exception("{0} is not a valid path".format(dir_c))
  if os.access(dir_c, os.R_OK):
    return dir_c
  else:
    raise Exception("{0} is not a readable dir".format(dir_c))

parser = argparse.ArgumentParser(description='Detect Url Benign/Malware')
parser.add_argument('strings', nargs='*',  help="The string to analyze")
parser.add_argument('-f', help="file to analyze")
parser.add_argument('-p', default='./' , help="where models are. default = ./")
parser.add_argument('-o', action='store_true', help="print result Json format")
parser.add_argument('-i','--info', action='store_true',  help="Print information")
args = parser.parse_args()


def nb(string):
    """ naive Bayes """
    load_nb = joblib.load(args.p + os.sep + "nb.joblib")
    return load_nb.predict(pd.Series(string))

def lr(string):
    """ LogisticRegression """
    load_lr = joblib.load(args.p + os.sep + "lr.joblib")
    return load_lr.predict(pd.Series(string))


def rf(string):
    """ RandomForest """
    load_rf = joblib.load(args.p + os.sep + "randomforest_tfidf.joblib")
    return load_rf.predict(pd.Series(string))


if __name__ == "__main__":
    result_dict = {}
    
    print(message)

    if args.f :
        try:
            lines = [x.rstrip('\n') for x in open(args.f,'r')]
            print("Analyse du fichier %s en cours" % (args.f))
            with tqdm(total=len(lines)) as bar :
                result_dict["Naive Bayes"] = nb(lines)
                bar.update(len(lines) / 3)
                result_dict["Logistic Regression"] = lr(lines)
                bar.update(len(lines) / 3)
                result_dict["Random Forest"] = rf(lines)
                bar.update(len(lines) / 3)

            df = pd.DataFrame(data = result_dict, index=lines)
            df['POI'] = np.where((df["Naive Bayes"] == 1.0) & (df["Logistic Regression"] == 1.0) & (df["Random Forest"] == 1.0), True, False)
            if args.o :
                print(df.to_json(orient="table"))
            else:
                print(df)   
        except FileNotFoundError:
            print("Error opening file")
    elif args.strings :
        print("Analyse de l'url %s en cours" % (args.strings))
        result_dict["Naive Bayes"] = nb(args.strings)[0]
        result_dict["Logistic Regression"] = lr(args.strings)[0]
        result_dict["Random Forest"] = rf(args.strings)[0]
        df = pd.DataFrame(data = result_dict, index=args.strings)
        df['POI'] = np.where((df["Naive Bayes"] == 1.0) & (df["Logistic Regression"] == 1.0) & (df["Random Forest"] == 1.0), True, False)
        if args.o:
            print(df.to_json(orient="table"))
        else:
            print(df)
    else:
        parser.print_help()
